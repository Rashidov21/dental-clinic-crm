{% extends 'base.html' %}
{% load translation_tags %}
{% block title %}{% trans "Dental CRM — Leads" %}{% endblock %}
{% block content %}
<div class="min-h-screen flex">
  <aside class="hidden md:flex md:w-64 lg:w-72 flex-col border-r border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/60 backdrop-blur">
    <div class="h-16 flex items-center gap-2 px-4 border-b border-gray-200 dark:border-gray-800">
      <div class="w-9 h-9 rounded-lg bg-teal-600 flex items-center justify-center text-white font-bold">DC</div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Dental Clinic" %}</div>
        <div class="font-semibold">{% trans "CRM" %}</div>
      </div>
    </div>
    <nav class="p-3 space-y-1 text-sm">
      <a href="/dashboard/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Dashboard" %}</a>
      <a href="/leads/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-teal-50 text-teal-700 dark:bg-teal-900/30 dark:text-teal-200 font-medium">{% trans "Leads" %}</a>
      <a href="/calendar/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Calendar" %}</a>
      <a href="/clients/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Clients & Database" %}</a>
      <a href="/payments/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Payments" %}</a>
      <a href="/book/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Book Appointment" %}</a>
      <a href="/doctor/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Doctor Dashboard" %}</a>
      <a href="/patient/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Patient" %}</a>
      <a href="/settings/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Settings" %}</a>
    </nav>
    <div class="mt-auto p-4 text-xs text-gray-500 dark:text-gray-400">© 2025 {% trans "Dental Clinic" %}</div>
  </aside>

  <div class="flex-1 flex flex-col min-w-0">
    <header class="h-16 flex items-center justify-between px-4 md:px-6 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800">
      <div class="flex items-center gap-3 md:hidden">
        <div class="w-9 h-9 rounded-lg bg-teal-600 flex items-center justify-center text-white font-bold">DC</div>
        <div class="font-semibold">{% trans "Dental CRM" %}</div>
      </div>
      <div class="hidden md:block font-semibold">{% trans "Leads" %}</div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-500 dark:text-gray-400 hidden sm:block">Dr. Emily Carter</span>
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-teal-500 to-blue-500"></div>
      </div>
    </header>

    <main class="p-4 md:p-6 space-y-4">
      
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 class="text-lg font-semibold">{% trans "New Patient Leads" %}</h1>
          <p class="text-sm text-gray-500">{% trans "Track and convert incoming leads" %}</p>
        </div>
        <button onclick="showModal('addLead')" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-teal-600 text-white text-sm font-medium hover:bg-teal-700">+ {% trans "Add Lead" %}</button>
      </div>

      <!-- Filter Controls -->
      <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
        <div class="flex flex-col sm:flex-row gap-4">
          <!-- Status Filter -->
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Filter by Status" %}</label>
            <select id="statusFilter" onchange="filterLeads()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
              <option value="">{% trans "All Statuses" %}</option>
              <option value="new">{% trans "New" %}</option>
              <option value="contacted">{% trans "Contacted" %}</option>
              <option value="qualified">{% trans "Qualified" %}</option>
              <option value="converted">{% trans "Converted" %}</option>
              <option value="lost">{% trans "Lost" %}</option>
            </select>
          </div>
          
          <!-- Date Filter -->
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Filter by Date" %}</label>
            <select id="dateFilter" onchange="filterLeads()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
              <option value="">{% trans "All Time" %}</option>
              <option value="today">{% trans "Today" %}</option>
              <option value="week">{% trans "This Week" %}</option>
              <option value="month">{% trans "This Month" %}</option>
            </select>
          </div>
          
          <!-- Clear Filters -->
          <div class="flex items-end">
            <button onclick="clearFilters()" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
              {% trans "Clear Filters" %}
            </button>
          </div>
        </div>
      </div>

      <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 dark:bg-gray-900/60 text-gray-600 dark:text-gray-300">
              <tr>
                <th class="text-left px-4 py-3">{% trans "Name" %}</th>
                <th class="text-left px-4 py-3">{% trans "Phone" %}</th>
                <th class="text-left px-4 py-3">{% trans "Status" %}</th>
                <th class="text-left px-4 py-3">{% trans "Source" %}</th>
                <th class="text-left px-4 py-3">{% trans "Created" %}</th>
                <th class="text-right px-4 py-3">{% trans "Actions" %}</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
              {% for lead in leads %}
              <tr class="lead-row" data-status="{{ lead.status }}" data-created="{{ lead.created_at|date:'Y-m-d' }}">
                <td class="px-4 py-3 font-medium">{{ lead.full_name }}</td>
                <td class="px-4 py-3 text-gray-600 dark:text-gray-300">{{ lead.phone }}</td>
                <td class="px-4 py-3">
                  {% if lead.status == 'new' %}
                    <span class="text-xs px-2 py-1 rounded bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-200">{% trans "New" %}</span>
                  {% elif lead.status == 'contacted' %}
                    <span class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200">{% trans "Contacted" %}</span>
                  {% elif lead.status == 'converted' %}
                    <span class="text-xs px-2 py-1 rounded bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200">{% trans "Converted" %}</span>
                  {% elif lead.status == 'lost' %}
                    <span class="text-xs px-2 py-1 rounded bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-200">{% trans "Lost" %}</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3">{{ lead.source|default:"—" }}</td>
                <td class="px-4 py-3">{{ lead.created_at|date:"M d, Y" }}</td>
                <td class="px-4 py-3 text-right space-x-2">
                  <button onclick="editLead({{ lead.id }}, '{{ lead.full_name|escapejs }}', '{{ lead.phone|escapejs }}', '{{ lead.source|escapejs }}', '{{ lead.status }}', '{{ lead.notes|escapejs }}')" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 text-gray-700 dark:text-gray-200">{% trans "Edit" %}</button>
                  <button onclick="deleteLead({{ lead.id }}, '{{ lead.full_name|escapejs }}')" class="px-3 py-1 rounded bg-red-50 text-red-700 hover:bg-red-100 dark:bg-red-900/30 dark:text-red-200">{% trans "Delete" %}</button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">{% trans "No leads found" %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Add Lead Modal -->
      <div id="addLead" class="modal fixed inset-0 z-50 items-center justify-center p-4 bg-black/40" style="display:none">
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold">{% trans "Add New Lead" %}</h3>
              <button onclick="closeModal('addLead')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <form method="post" action="/leads/page/create/" class="space-y-4">
              {% csrf_token %}
              <div>
                <label for="full_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Full Name" %}</label>
                <input type="text" id="full_name" name="full_name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
              </div>
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Phone" %}</label>
                <input type="tel" id="phone" name="phone" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
              </div>
              <div>
                <label for="source" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Source" %}</label>
                <select id="source" name="source" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
                  <option value="">{% trans "Select Source" %}</option>
                  <option value="Google Ads">{% trans "Google Ads" %}</option>
                  <option value="Facebook">{% trans "Facebook" %}</option>
                  <option value="Referral">{% trans "Referral" %}</option>
                  <option value="Website">{% trans "Website" %}</option>
                  <option value="Other">{% trans "Other" %}</option>
                </select>
              </div>
              <div>
                <label for="assigned_doctor" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Assign to Doctor" %}</label>
                <select id="assigned_doctor" name="assigned_doctor" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
                  <option value="">{% trans "Select Doctor" %}</option>
                  {% for doctor in doctors %}
                  <option value="{{ doctor.id }}">{{ doctor.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Status" %}</label>
                <select id="status" name="status" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
                  <option value="new">{% trans "New" %}</option>
                  <option value="contacted">{% trans "Contacted" %}</option>
                  <option value="converted">{% trans "Converted" %}</option>
                  <option value="lost">{% trans "Lost" %}</option>
                </select>
              </div>
              <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Notes" %}</label>
                <textarea id="notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white"></textarea>
              </div>
              <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal('addLead')" class="flex-1 px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">{% trans "Cancel" %}</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">{% trans "Add Lead" %}</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Edit Lead Modal -->
      <div id="editLead" class="modal fixed inset-0 z-50 items-center justify-center p-4 bg-black/40" style="display:none">
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold">{% trans "Edit Lead" %}</h3>
              <button onclick="closeModal('editLead')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <form id="editLeadForm" method="post" class="space-y-4">
              {% csrf_token %}
              <div>
                <label for="edit_full_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Full Name" %}</label>
                <input type="text" id="edit_full_name" name="full_name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
              </div>
              <div>
                <label for="edit_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Phone" %}</label>
                <input type="tel" id="edit_phone" name="phone" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
              </div>
              <div>
                <label for="edit_source" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Source" %}</label>
                <select id="edit_source" name="source" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
                  <option value="">{% trans "Select Source" %}</option>
                  <option value="Google Ads">{% trans "Google Ads" %}</option>
                  <option value="Facebook">{% trans "Facebook" %}</option>
                  <option value="Referral">{% trans "Referral" %}</option>
                  <option value="Website">{% trans "Website" %}</option>
                  <option value="Other">{% trans "Other" %}</option>
                </select>
              </div>
              <div>
                <label for="edit_assigned_doctor" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Assign to Doctor" %}</label>
                <select id="edit_assigned_doctor" name="assigned_doctor" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
                  <option value="">{% trans "Select Doctor" %}</option>
                  {% for doctor in doctors %}
                  <option value="{{ doctor.id }}">{{ doctor.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="edit_status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Status" %}</label>
                <select id="edit_status" name="status" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
                  <option value="new">{% trans "New" %}</option>
                  <option value="contacted">{% trans "Contacted" %}</option>
                  <option value="converted">{% trans "Converted" %}</option>
                  <option value="lost">{% trans "Lost" %}</option>
                </select>
              </div>
              <div>
                <label for="edit_notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Notes" %}</label>
                <textarea id="edit_notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-800 dark:text-white"></textarea>
              </div>
              <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal('editLead')" class="flex-1 px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">{% trans "Cancel" %}</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">{% trans "Update Lead" %}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
// Modal functionality
function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        closeModal(event.target.id);
    }
});

// Handle edit lead functionality
function editLead(leadId, fullName, phone, source, status, notes) {
    // Populate the edit form with current data
    document.getElementById('edit_full_name').value = fullName;
    document.getElementById('edit_phone').value = phone;
    document.getElementById('edit_source').value = source;
    document.getElementById('edit_status').value = status;
    document.getElementById('edit_notes').value = notes;
    
    // Set the form action to the correct update URL
    document.getElementById('editLeadForm').action = `/leads/page/${leadId}/update/`;
    
    // Show the modal
    showModal('editLead');
}

// Handle delete lead functionality
function deleteLead(leadId, leadName) {
    const message = `Are you sure you want to delete the lead "${leadName}"? This action cannot be undone.`;
    const deleteUrl = `/leads/page/${leadId}/delete/`;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    confirmDelete(message, deleteUrl, csrfToken);
}

// Filter leads functionality
function filterLeads() {
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const leadRows = document.querySelectorAll('.lead-row');
    
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay());
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    leadRows.forEach(row => {
        let showRow = true;
        
        // Status filter
        if (statusFilter && row.dataset.status !== statusFilter) {
            showRow = false;
        }
        
        // Date filter
        if (dateFilter && showRow) {
            const createdDate = new Date(row.dataset.created);
            
            switch (dateFilter) {
                case 'today':
                    if (createdDate.toDateString() !== today.toDateString()) {
                        showRow = false;
                    }
                    break;
                case 'week':
                    if (createdDate < startOfWeek) {
                        showRow = false;
                    }
                    break;
                case 'month':
                    if (createdDate < startOfMonth) {
                        showRow = false;
                    }
                    break;
            }
        }
        
        // Show/hide row
        row.style.display = showRow ? '' : 'none';
    });
}

// Clear all filters
function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFilter').value = '';
    
    // Show all rows
    const leadRows = document.querySelectorAll('.lead-row');
    leadRows.forEach(row => {
        row.style.display = '';
    });
}
</script>
{% endblock %}


