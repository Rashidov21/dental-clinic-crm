{% extends 'base.html' %}
{% load translation_tags %}
{% block title %}{% trans "Dental CRM — Dashboard" %}{% endblock %}
{% block content %}
<div class="min-h-screen flex">
  <!-- Sidebar -->
  <aside class="hidden md:flex md:w-64 lg:w-72 flex-col border-r border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/60 backdrop-blur">
    <div class="h-16 flex items-center gap-2 px-4 border-b border-gray-200 dark:border-gray-800">
      <div class="w-9 h-9 rounded-lg bg-teal-600 flex items-center justify-center text-white font-bold">DC</div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Dental Clinic" %}</div>
        <div class="font-semibold">{% trans "CRM" %}</div>
      </div>
    </div>
    <nav class="p-3 space-y-1 text-sm">
      <a href="/dashboard/" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-teal-50 text-teal-700 dark:bg-teal-900/30 dark:text-teal-200 font-medium">{% trans "Dashboard" %}</a>
      <a href="/leads/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Leads" %}</a>
      <a href="/calendar/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Calendar" %}</a>
      <a href="/clients/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Clients & Database" %}</a>
      <a href="/payments/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Payments" %}</a>
      <a href="/book/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Book Appointment" %}</a>
      <a href="/doctor/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Doctor Dashboard" %}</a>
      <a href="/patient/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Patient" %}</a>
      <a href="/settings/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Settings" %}</a>
    </nav>
    <div class="mt-auto p-4 text-xs text-gray-500 dark:text-gray-400">© 2025 {% trans "Dental Clinic" %}</div>
  </aside>

  <!-- Main -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- Topbar -->
    <header class="h-16 flex items-center justify-between px-4 md:px-6 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800">
      <div class="flex items-center gap-3 md:hidden">
        <div class="w-9 h-9 rounded-lg bg-teal-600 flex items-center justify-center text-white font-bold">DC</div>
        <div class="font-semibold">{% trans "Dental CRM" %}</div>
      </div>
      <div class="hidden md:block font-semibold">{% trans "Dashboard" %}</div>
      <div class="flex items-center gap-3">
        <!-- Language Switcher -->
        <div class="flex items-center gap-1 text-xs">
          <a href="{% url 'set_language' %}?next={{ request.path }}&language=uz" class="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">UZ</a>
          <a href="{% url 'set_language' %}?next={{ request.path }}&language=uz-Cyrl" class="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">ЎЗ</a>
          <a href="{% url 'set_language' %}?next={{ request.path }}&language=ru" class="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">RU</a>
        </div>
        
        <!-- Profile Dropdown -->
        {% if user.is_authenticated %}
          <div class="relative">
            <button onclick="toggleDropdown()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
              <div class="w-9 h-9 rounded-full bg-gradient-to-br from-teal-500 to-blue-500"></div>
              <span class="text-sm hidden sm:block">{{ user.get_full_name|default:user.username }}</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50">
              <a href="{% url 'profile' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Profile" %}</a>
              <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Logout" %}</a>
            </div>
          </div>
        {% else %}
          <a href="{% url 'login' %}" class="px-3 py-2 rounded-lg bg-teal-600 text-white text-sm hover:bg-teal-700">{% trans "Login" %}</a>
        {% endif %}
      </div>
    </header>

    <!-- Content -->
    <main class="p-4 md:p-6 space-y-6">
      <!-- Stats -->
      <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Total Patients" %}</div>
          <div class="mt-2 text-2xl font-semibold">{% if total_patients %}{{ total_patients }}{% else %}0{% endif %}</div>
          <div class="mt-1 text-xs text-emerald-600">{% trans "+4.1% this month" %}</div>
        </div>
        <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Today's Appointments" %}</div>
          <div class="mt-2 text-2xl font-semibold">{% if total_appointments_today %}{{ total_appointments_today }}{% else %}0{% endif %}</div>
          <div class="mt-1 text-xs text-blue-600">{% trans "6 completed" %}</div>
        </div>
        <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Total Income" %}</div>
          <div class="mt-2 text-2xl font-semibold">{% if total_income %}{{ total_income }}{% else %}0{% endif %}</div>
          <div class="mt-1 text-xs text-emerald-600">{% trans "+$1,240 today" %}</div>
        </div>
        <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Leads this Month" %}</div>
          <div class="mt-2 text-2xl font-semibold">{% if leads_this_month %}{{ leads_this_month }}{% else %}0{% endif %}</div>
          <div class="mt-1 text-xs text-orange-600">{% trans "12 pending" %}</div>
        </div>
      </section>

      <!-- Quick Actions -->
      <section class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold">{% trans "Quick Actions" %}</h2>
        </div>
        <div class="flex flex-wrap gap-3">
          <button onclick="showModal('addPatient')" class="inline-flex items-center gap-2 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            {% trans "Add New Patient" %}
          </button>
          <a href="/leads/page/" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            {% trans "View Leads" %}
          </a>
          <a href="/book/" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            {% trans "Book Appointment" %}
          </a>
        </div>
      </section>

      <!-- Mini summaries -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">{% trans "Upcoming Today" %}</h2>
            <a href="/calendar/" class="text-sm text-teal-700 dark:text-teal-300">{% trans "View calendar" %}</a>
          </div>
          <ul class="mt-3 divide-y divide-gray-200 dark:divide-gray-800">
            <li class="py-3 flex items-center justify-between">
              <div>
                <div class="font-medium">John Miller — Cleaning</div>
                <div class="text-xs text-gray-500">10:00 AM • Dr. Carter</div>
              </div>
              <span class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200">Room 2</span>
            </li>
            <li class="py-3 flex items-center justify-between">
              <div>
                <div class="font-medium">Sofia Perez — Whitening</div>
                <div class="text-xs text-gray-500">11:30 AM • Dr. Lee</div>
              </div>
              <span class="text-xs px-2 py-1 rounded bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-200">{% trans "New" %}</span>
            </li>
            <li class="py-3 flex items-center justify-between">
              <div>
                <div class="font-medium">Akira Tanaka — Implant Consult</div>
                <div class="text-xs text-gray-500">1:00 PM • Dr. Patel</div>
              </div>
              <span class="text-xs px-2 py-1 rounded bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200">{% trans "Confirmed" %}</span>
            </li>
          </ul>
        </div>
        <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <h2 class="font-semibold">{% trans "Leads Status" %}</h2>
          <div class="mt-3 space-y-3">
            <div class="flex items-center justify-between text-sm">
              <span>{% trans "New" %}</span>
              <span class="font-medium">{{ leads_new }}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span>{% trans "Contacted" %}</span>
              <span class="font-medium">{{ leads_contacted }}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span>{% trans "Converted" %}</span>
              <span class="font-medium">{{ leads_converted }}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span>{% trans "Lost" %}</span>
              <span class="font-medium">{{ leads_lost }}</span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<script>
function toggleDropdown() {
  const dropdown = document.getElementById('profileDropdown');
  dropdown.classList.toggle('hidden');
}

document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('profileDropdown');
  const button = event.target.closest('button');
  if (!button || !button.onclick) {
    dropdown.classList.add('hidden');
  }
});
</script>

<!-- Add Patient Modal -->
<div id="addPatient" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center" style="display:none">
  <div class="p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{% trans "Add New Patient & Book Appointment" %}</h3>
      </div>
      <form method="post" action="{% url 'patient_create_with_booking' %}" class="space-y-4">
        {% csrf_token %}
        <div class="px-6 py-4 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Full Name" %}</label>
              <input type="text" name="full_name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Phone" %}</label>
              <input type="tel" name="phone" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Email" %}</label>
              <input type="email" name="email" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Birth Date" %}</label>
              <input type="date" name="birth_date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Address" %}</label>
            <input type="text" name="address" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
          </div>
          
          <!-- Appointment Booking Section -->
          <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-3">{% trans "Book Appointment" %}</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Select Doctor" %}</label>
                <select name="doctor" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                  <option value="">{% trans "Select Doctor" %}</option>
                  {% for doctor in doctors %}
                  <option value="{{ doctor.id }}">{{ doctor.name }} - {{ doctor.specialization }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Select Treatment" %}</label>
                <select name="treatment" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                  <option value="">{% trans "Select Treatment" %}</option>
                  {% for treatment in treatments %}
                  <option value="{{ treatment.id }}">{{ treatment.name }} - ${{ treatment.price }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Appointment Date" %}</label>
                <input type="date" name="date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Appointment Time" %}</label>
                <input type="time" name="time" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Notes" %}</label>
              <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent dark:bg-gray-700 dark:text-white"></textarea>
            </div>
          </div>
        </div>
        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 flex justify-end space-x-3">
          <button type="button" onclick="closeModal('addPatient')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">{% trans "Cancel" %}</button>
          <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors">{% trans "Add Patient & Book" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}


