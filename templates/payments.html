{% extends 'base.html' %}
{% load i18n %}
{% load translation_tags %}
{% block title %}{% trans "Dental CRM â€” Payments" %}{% endblock %}
{% block content %}
<div class="min-h-screen flex">
  <aside class="hidden md:flex md:w-64 lg:w-72 flex-col border-r border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/60 backdrop-blur">
    <div class="h-16 flex items-center gap-2 px-4 border-b border-gray-200 dark:border-gray-800">
      <div class="w-9 h-9 rounded-lg bg-teal-600 flex items-center justify-center text-white font-bold">DC</div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Dental Clinic" %}</div>
        <div class="font-semibold">{% trans "CRM" %}</div>
      </div>
    </div>
    <nav class="p-3 space-y-1 text-sm">
      <a href="/dashboard/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Dashboard" %}</a>
      <a href="/leads/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Leads" %}</a>
      <a href="/calendar/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Calendar" %}</a>
      <a href="/clients/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Clients & Database" %}</a>
      <a href="/payments/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-teal-50 text-teal-700 dark:bg-teal-900/30 dark:text-teal-200 font-medium">{% trans "Payments" %}</a>
      <a href="/book/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Book Appointment" %}</a>
      <a href="/doctor/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Doctor Dashboard" %}</a>
      <a href="/patient/page/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Patient" %}</a>
      <a href="/settings/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">{% trans "Settings" %}</a>
    </nav>
    <div class="mt-auto p-4 text-xs text-gray-500 dark:text-gray-400">Â© 2025 {% trans "Dental Clinic" %}</div>
  </aside>

  <div class="flex-1 flex flex-col min-w-0">
    <header class="h-16 flex items-center justify-between px-4 md:px-6 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800">
      <div class="flex items-center gap-3 md:hidden">
        <div class="w-9 h-9 rounded-lg bg-teal-600 flex items-center justify-center text-white font-bold">DC</div>
        <div class="font-semibold">{% trans "Dental CRM" %}</div>
      </div>
      <div class="hidden md:block font-semibold">{% trans "Payments" %}</div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-500 dark:text-gray-400 hidden sm:block">{% trans "Admin" %}</span>
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-teal-500 to-blue-500"></div>
      </div>
    </header>

    <main class="p-4 md:p-6 space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-1 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <h2 class="font-semibold">{% trans "Record Payment" %}</h2>
          <form class="mt-3 space-y-3 text-sm">
            <div>
              <label class="block text-sm mb-1">{% trans "Patient" %}</label>
              <select name="patient" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2">
                <option value="">{% trans "Select Patient" %}</option>
                {% for patient in patients %}
                <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">{% trans "Amount" %}</label>
                <input type="number" name="amount" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2" placeholder="0.00" />
              </div>
              <div>
                <label class="block text-sm mb-1">{% trans "Type" %}</label>
                <select name="payment_type" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2">
                  <option value="cash">{% trans "Cash" %}</option>
                  <option value="card">{% trans "Card" %}</option>
                  <option value="online">{% trans "Online" %}</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">{% trans "Date" %}</label>
                <input type="date" name="date" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm mb-1">{% trans "Status" %}</label>
                <select name="status" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2">
                  <option value="paid">{% trans "Paid" %}</option>
                  <option value="pending">{% trans "Pending" %}</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm mb-1">{% trans "Notes" %}</label>
              <textarea name="notes" rows="3" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2" placeholder="{% trans 'Optional notes...' %}"></textarea>
            </div>
            <div class="pt-2">
              <button type="button" onclick="savePayment()" class="w-full sm:w-auto px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700">{% trans "Save Payment" %}</button>
            </div>
          </form>
        </div>

        <div class="lg:col-span-2 bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl overflow-hidden">
          <div class="p-4 flex items-center justify-between">
            <h2 class="font-semibold">{% trans "Recent Payments" %}</h2>
            <div class="text-xs text-gray-500 dark:text-gray-400">{% trans "Last 7 days" %}</div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50 dark:bg-gray-900/60 text-gray-600 dark:text-gray-300">
                <tr>
                  <th class="text-left px-4 py-3">{% trans "Patient" %}</th>
                  <th class="text-left px-4 py-3">{% trans "Amount" %}</th>
                  <th class="text-left px-4 py-3">{% trans "Type" %}</th>
                  <th class="text-left px-4 py-3">{% trans "Date" %}</th>
                  <th class="text-left px-4 py-3">{% trans "Status" %}</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                {% for payment in payments %}
                <tr class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors" onclick="viewPaymentReceipt({{ payment.id }})">
                  <td class="px-4 py-3 text-gray-900 dark:text-white">{{ payment.patient.full_name }}</td>
                  <td class="px-4 py-3 text-gray-900 dark:text-white font-medium">${{ payment.amount }}</td>
                  <td class="px-4 py-3 text-gray-900 dark:text-white">{{ payment.get_payment_type_display }}</td>
                  <td class="px-4 py-3 text-gray-900 dark:text-white">{{ payment.date|date:'M d, Y' }}</td>
                  <td class="px-4 py-3">
                    <span class="text-xs px-2 py-1 rounded {% if payment.status == 'paid' %}bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200{% else %}bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-200{% endif %}">
                      {{ payment.get_status_display }}
                    </span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">{% trans "No payments found" %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          {% if paginator.num_pages > 1 %}
          <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-700 dark:text-gray-300">
                {% trans "Showing" %} {{ payments.start_index }} {% trans "to" %} {{ payments.end_index }} {% trans "of" %} {{ paginator.count }} {% trans "payments" %}
              </div>
              <div class="flex items-center space-x-2">
                {% if payments.has_previous %}
                  <a href="?page=1{% if request.GET.patient %}&patient={{ request.GET.patient }}{% endif %}{% if request.GET.start %}&start={{ request.GET.start }}{% endif %}{% if request.GET.end %}&end={{ request.GET.end }}{% endif %}" 
                     class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    {% trans "First" %}
                  </a>
                  <a href="?page={{ payments.previous_page_number }}{% if request.GET.patient %}&patient={{ request.GET.patient }}{% endif %}{% if request.GET.start %}&start={{ request.GET.start }}{% endif %}{% if request.GET.end %}&end={{ request.GET.end }}{% endif %}" 
                     class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    {% trans "Previous" %}
                  </a>
                {% endif %}
                
                <span class="px-3 py-1 text-sm text-gray-700 dark:text-gray-300">
                  {% trans "Page" %} {{ payments.number }} {% trans "of" %} {{ paginator.num_pages }}
                </span>
                
                {% if payments.has_next %}
                  <a href="?page={{ payments.next_page_number }}{% if request.GET.patient %}&patient={{ request.GET.patient }}{% endif %}{% if request.GET.start %}&start={{ request.GET.start }}{% endif %}{% if request.GET.end %}&end={{ request.GET.end }}{% endif %}" 
                     class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    {% trans "Next" %}
                  </a>
                  <a href="?page={{ paginator.num_pages }}{% if request.GET.patient %}&patient={{ request.GET.patient }}{% endif %}{% if request.GET.start %}&start={{ request.GET.start }}{% endif %}{% if request.GET.end %}&end={{ request.GET.end }}{% endif %}" 
                     class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    {% trans "Last" %}
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Total Income" %}</div>
          <div class="text-2xl font-semibold mt-1 text-gray-900 dark:text-white">$24,560</div>
        </div>
        <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Total Expenses" %}</div>
          <div class="text-2xl font-semibold mt-1 text-gray-900 dark:text-white">$8,440</div>
        </div>
        <div class="bg-white dark:bg-gray-950 border border-gray-200 dark:border-gray-800 rounded-xl p-4">
          <div class="text-sm text-gray-500 dark:text-gray-400">{% trans "Net" %}</div>
          <div class="text-2xl font-semibold mt-1 text-gray-900 dark:text-white">$16,120</div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
// Payment form functionality
function savePayment() {
    // Get form data
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    // Validate required fields
    const patient = form.querySelector('select').value;
    const amount = form.querySelector('input[type="number"]').value;
    const type = form.querySelectorAll('select')[1].value;
    const date = form.querySelector('input[type="date"]').value;
    const status = form.querySelectorAll('select')[2].value;
    
    if (!patient || !amount || !type || !date || !status) {
        showToast('{% trans "Please fill in all required fields" %}', 'error');
        return;
    }
    
    if (parseFloat(amount) <= 0) {
        showToast('{% trans "Amount must be greater than zero" %}', 'error');
        return;
    }
    
    // Simulate payment processing
    showToast('{% trans "Processing payment..." %}', 'info');
    
    // Simulate API call
    setTimeout(() => {
        // Show success message
        showToast('{% trans "Payment saved successfully" %}', 'success');
        
        // Reset form
        form.reset();
        
        // In a real application, you would:
        // 1. Send data to backend
        // 2. Update the payments table
        // 3. Refresh the page or update the UI
    }, 1500);
}

// Form validation on input
document.addEventListener('DOMContentLoaded', function() {
    const amountInput = document.querySelector('input[type="number"]');
    const dateInput = document.querySelector('input[type="date"]');
    
    // Set today's date as default
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Validate amount input
    if (amountInput) {
        amountInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (value < 0) {
                this.value = '';
                showToast('{% trans "Amount cannot be negative" %}', 'error');
            }
        });
    }
    
    // Auto-calculate totals (if needed)
    updateTotals();
});

// Update financial totals
function updateTotals() {
    // In a real application, this would fetch data from the backend
    // For now, we'll just ensure the display is correct
    const incomeElement = document.querySelector('.text-2xl');
    if (incomeElement) {
        // You could add animation or real-time updates here
    }
}

// Payment type specific logic
function handlePaymentType(type) {
    const amountInput = document.querySelector('input[type="number"]');
    
    switch(type) {
        case '{% trans "Cash" %}':
            // Cash payments might have different validation
            break;
        case '{% trans "Card" %}':
            // Card payments might require additional fields
            break;
        case '{% trans "Transfer" %}':
            // Transfer payments might need reference numbers
            break;
    }
}

// Add event listeners for payment type changes
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.querySelectorAll('select')[1];
    if (typeSelect) {
        typeSelect.addEventListener('change', function() {
            handlePaymentType(this.value);
        });
    }
});

// View payment receipt
function viewPaymentReceipt(paymentId) {
    // Redirect to receipt page with payment ID
    window.location.href = `/receipt/page/?payment_id=${paymentId}`;
}
</script>
{% endblock %}


